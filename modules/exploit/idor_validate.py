import requests
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def mutate_object_id(url):
    """
    Replace trailing numeric ID with a neighboring value.
    /users/1 -> /users/2
    """
    for i in range(len(url) - 1, -1, -1):
        if url[i].isdigit():
            return url[:i] + "2"
    return None


def run(context):
    confirmed = []

    for finding in context.findings:
        if finding.get("type") != "idor_candidate":
            continue

        original_url = finding["url"]
        test_url = mutate_object_id(original_url)

        if not test_url:
            continue

        try:
            r_original = requests.get(
                original_url,
                timeout=5,
                verify=False,
                headers=context.headers,
                cookies=context.cookies
            )

            r_test = requests.get(
                test_url,
                timeout=5,
                verify=False,
                headers=context.headers,
                cookies=context.cookies
            )

            if (
                r_original.status_code == 200
                and r_test.status_code == 200
                and r_original.text != r_test.text
            ):
                print(f"[IDOR CONFIRMED] {test_url}")

                finding = {
                    "type": "idor_confirmed",
                    "original_url": original_url,
                    "tested_url": test_url,
                    "impact": "Horizontal privilege escalation",
                    "severity": "High"
                }

                confirmed.append(finding)

                context.add_evidence({
                    "original_status": r_original.status_code,
                    "tested_status": r_test.status_code,
                    "tested_url": test_url
                })

        except requests.RequestException:
            pass

    context.findings.extend(confirmed)
    return confirmed

